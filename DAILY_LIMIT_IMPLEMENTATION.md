# Daily Analogy Generation Limits Implementation

This document describes the implementation of daily analogy generation limits and rate limiting for the Analogous application.

## Overview

The system now enforces daily limits and rate limits based on user subscription plans:

- **Curious Plan (Free)**: 20 analogies per day, 1 analogy per minute
- **Scholar Plan (Paid)**: 100 analogies per day, 5 analogies per minute

## Database Schema Changes

### New Columns Added to `user_information` Table

1. **`daily_analogies_generated`** (INTEGER, DEFAULT 0)
   - Tracks how many analogies the user has generated today
   - Resets at midnight in the user's timezone

2. **`last_analogy_time`** (TIMESTAMPTZ) - *Existing column*
   - Records when the user last generated an analogy
   - Used for rate limiting calculations
   - Already exists in your database

3. **`daily_reset_date`** (DATE)
   - Tracks when the daily count was last reset
   - Ensures proper daily reset in user's timezone

4. **`lifetime_analogies_generated`** (INTEGER, DEFAULT 0)
   - Tracks total analogies generated by the user
   - Increments with each analogy generation

### Database Setup

Run the SQL script `backend/add_daily_limit_columns.sql` in your Supabase SQL editor to add these columns.

## Implementation Details

### Rate Limiting Logic

The rate limiting is implemented in two main functions:
- `generate_analogy()` - For new analogy generation
- `regenerate_analogy()` - For analogy regeneration

#### Daily Limit Check
1. Get user's current plan and daily count
2. Check if it's a new day in user's timezone
3. Reset daily count if it's a new day
4. Reject request if daily limit is exceeded

#### Rate Limit Check
1. Get user's last analogy generation time
2. Calculate time since last generation
3. Reject request if rate limit is exceeded
4. Provide remaining wait time in error message

### Timezone Handling

The system respects user timezones for daily resets:
- Daily counts reset at midnight in the user's timezone
- Uses the `get_user_current_date()` function for timezone-aware date calculations
- Stores reset dates in user's timezone for accurate daily tracking

### Error Messages

The system provides clear error messages:
- **Daily Limit Exceeded**: 
  - **Curious Plan**: "You have reached your daily limit of {limit} analogies. Please upgrade to the Scholar plan for more analogies per day. Visit your pricing page to view your usage statistics and upgrade options."
  - **Scholar Plan**: "You have reached your daily limit of {limit} analogies for today. Your limit will reset tomorrow. Visit your pricing page to view your usage statistics."
- **Rate Limit Exceeded**: "Rate limit exceeded. Please wait {seconds} seconds before generating another analogy."

## API Changes

### Updated Endpoints

#### `POST /generate-analogy`
- Now includes rate limiting and daily limit checks
- Updates daily count and last generation time on success

#### `POST /regenerate-analogy/{analogy_id}`
- Now includes rate limiting and daily limit checks
- Updates daily count and last generation time on success

#### `GET /user/{user_id}/pricing-stats`
- Updated response model to include `dailyLimit` and `rateLimitSeconds`
- Now uses `daily_analogies_generated` field instead of counting from analogies table

### Updated Response Models

#### `UserStatsResponse`
```typescript
{
  currentPlan: string;
  renewalDate: string;
  analogiesGeneratedToday: number;
  analogiesStoredTotal: number;
  upcomingPlan: string | null;
  planCancelled: boolean;
  subscriptionStartDate: string | null;
  dailyLimit: number;        // NEW
  rateLimitSeconds: number;  // NEW
}
```

## Plan Limits

| Plan | Daily Limit | Rate Limit | Rate Limit (seconds) |
|------|-------------|------------|---------------------|
| Curious | 20 | 1 per minute | 60 |
| Scholar | 100 | 5 per minute | 12 |

## User Experience

### Frontend Integration

The frontend can now:
1. Display current daily usage vs. daily limit
2. Show rate limit information
3. Display upgrade prompts when limits are reached
4. Show countdown timers for rate limits

### Error Handling

The system gracefully handles:
- Database connection issues (continues with analogy generation)
- Invalid date formats (defaults to current behavior)
- Missing user data (provides appropriate error messages)

## Testing

### Test Scenarios

1. **Daily Limit Testing**
   - Generate analogies up to daily limit
   - Verify rejection at limit
   - Test daily reset at midnight

2. **Rate Limit Testing**
   - Generate analogies rapidly
   - Verify rate limit enforcement
   - Test countdown timer accuracy

3. **Plan Upgrade Testing**
   - Test limit changes after plan upgrade
   - Verify immediate limit increase

4. **Timezone Testing**
   - Test daily reset in different timezones
   - Verify accurate daily tracking

### Admin Testing Endpoints

Use the existing admin endpoints to test different scenarios:
- `POST /admin/test/set-user-plan-state` - Set user plan for testing
- `POST /admin/test/simulate-date` - Simulate different dates for testing

## Monitoring

### Key Metrics to Monitor

1. **Rate Limit Hits**: Track how often users hit rate limits
2. **Daily Limit Hits**: Monitor daily limit usage patterns
3. **Plan Upgrade Conversions**: Track upgrades after hitting limits
4. **Error Rates**: Monitor for any implementation issues

### Logging

The system logs:
- Rate limit violations with remaining wait time
- Daily limit violations with current usage
- Database errors during limit checks
- Successful limit updates

## Migration Notes

### Existing Users

- All existing users will start with 0 daily analogies generated
- Daily counts will reset on their next analogy generation
- No data migration required

### Backward Compatibility

- The system gracefully handles missing columns
- Defaults to allowing analogy generation if limit checks fail
- Maintains existing functionality for users without new columns

## Future Enhancements

### Potential Improvements

1. **Flexible Limits**: Allow dynamic limit adjustment based on usage patterns
2. **Grace Periods**: Provide temporary limit increases for active users
3. **Usage Analytics**: Track usage patterns to optimize limits
4. **A/B Testing**: Test different limit configurations
5. **Premium Features**: Add unlimited generation for premium tiers

### Performance Optimizations

1. **Caching**: Cache user limit data to reduce database queries
2. **Batch Updates**: Batch limit updates for high-traffic scenarios
3. **Indexing**: Add indexes for frequently queried limit fields 